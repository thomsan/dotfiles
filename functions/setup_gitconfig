# Shell function - sourced by bootstrap
# Works with: bash, zsh
#
# Interactive Git configuration setup
# Creates gitconfig.local.symlink with user credentials

setup_gitconfig () {
    info 'setup gitconfig'
    if ! [ -f topics/git/gitconfig.local.symlink ]
    then
        local platform=$(get_platform)

        # Platform-specific git credential helper and gpg program
        # Installation of dependencies (e.g. libsecret) is handled in {platform}/.bootstrap
        local git_credential=''
        local gpg_program='gpg'
        case "$platform" in
            darwin)
                git_credential='osxkeychain'
                ;;
            linux)
                git_credential='/usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret'
                ;;
            windows|cygwin)
                git_credential='manager'
                ;;
            *)
                warn "unknown platform '$platform', no credential helper configured"
                ;;
        esac

        user ' - What is your github author name?'
        read -e git_authorname < /dev/tty
        user ' - What is your github author email?'
        read -e git_authoremail < /dev/tty


        # escape git_credentials sed delimiter /
        git_credential=$(echo $git_credential | sed -e 's/[\/&]/\\&/g')
        cp topics/git/gitconfig.local.symlink.example topics/git/gitconfig.local.symlink
        sed -i "s/AUTHORNAME/$git_authorname/g" topics/git/gitconfig.local.symlink
        sed -i "s/AUTHOREMAIL/$git_authoremail/g" topics/git/gitconfig.local.symlink
        sed -i "s/GIT_CREDENTIAL_HELPER/$git_credential/g" topics/git/gitconfig.local.symlink
        sed -i "s/GPG_PROGRAM/$gpg_program/g" topics/git/gitconfig.local.symlink

        # Windows: pre-select Git Credential Manager to suppress the helper picker popup
        if [ "$platform" == "windows" ]; then
            git config --file topics/git/gitconfig.local.symlink credential.helperselector.selected manager
        fi

        success 'gitconfig setup finished'
    else
        success 'gitconfig already set up'
    fi


}
