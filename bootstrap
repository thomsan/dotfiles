#!/usr/bin/env bash

# This script is used to bootstrap a new machine.

DOTFILES_ROOT=$(pwd -P)

set -e

on_error() {
  local exit_code=$?
  printf "\r\e[2K[\e[01;31mFAIL\e[0m] bootstrap failed at line %d (exit code: %d)\n" "$1" "$exit_code" >&2
  exit "$exit_code"
}
trap 'on_error $LINENO' ERR

# Enable native Windows symlinks in Git Bash/MSYS
export MSYS=winsymlinks:nativestrict

# include all functions
for file in $DOTFILES_ROOT/functions/*; do
  source $file
done

install_dotfiles () {
  info 'installing dotfiles'

  local overwrite_all=false backup_all=false skip_all=false

  for src in $(find -H "$DOTFILES_ROOT/topics" -maxdepth 2 -name '*.symlink' -not -path '*.git*')
  do
    dst="$HOME/.$(basename "${src%.*}")"
    link_file "$src" "$dst"
  done
  success 'dotfiles installation finished'
}

run_topic_bootstrap_files () {
  info 'running topic specific bootstrap files'
  local failed=0

  for src in $(find -H "$DOTFILES_ROOT/topics/" -maxdepth 2 -name '*.bootstrap' -not -path '*.git*')
  do
    info "running $src"
    if ! (source "$src"); then
      warn "bootstrap file failed: $src"
      failed=$((failed + 1))
    fi
  done

  if [ $failed -gt 0 ]; then
    warn "$failed topic bootstrap file(s) had errors"
  else
    success 'topic bootstrap finished'
  fi
}

run_platform_bootstrap_files () {
  platform=$(get_platform)
  info 'running platform specific bootstrap files'
  info "detected platform: $platform"

  if [ ! -d "$DOTFILES_ROOT/$platform" ]; then
    warn "no platform directory found for '$platform', skipping"
    return 0
  fi

  local failed=0

  for src in $(find -H "$DOTFILES_ROOT/$platform" -maxdepth 2 -name '*.bootstrap' -not -path '*.git*')
  do
    info "running $src"
    if ! (source "$src"); then
      warn "bootstrap file failed: $src"
      failed=$((failed + 1))
    fi
  done

  if [ $failed -gt 0 ]; then
    warn "$failed platform bootstrap file(s) had errors"
  else
    success 'platform bootstrap files finished'
  fi
}

setup_gitconfig
echo ''
setup_gpg
echo ''
install_dotfiles
echo ''
run_topic_bootstrap_files
echo ''
run_platform_bootstrap_files
echo ''
success 'bootstrap complete'
